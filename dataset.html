<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Database Management</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* =========================
   HIGH-TECH THEME
========================= */
:root {
    --bg-main: #020a13; --glass-panel: rgba(5, 21, 37, 0.85);
    --accent-cyan: #00f7ff; --accent-blue: #0066ff; --accent-red: #ff2a6d; --accent-green: #3be482;
    --text-bright: #ffffff; --text-dim: #a0aebf;
    --glow-cyan: 0 0 15px rgba(0, 247, 255, 0.4); --border-glow: 1px solid rgba(0, 247, 255, 0.25);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body, html {
    height: 100%; font-family: 'Inter', sans-serif; background-color: var(--bg-main);
    background-image: linear-gradient(rgba(2, 10, 19, 0.92), rgba(2, 10, 19, 0.95)), url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M54.627 0l.83.828-1.415 1.415-.828-.828.828-.828zm-1.415 1.415l.828.828-1.415 1.415-.828-.828.828-.828z' fill='%23112233' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
    overflow: hidden;
}

/* === TOAST NOTIFICATIONS === */
#toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
.toast {
    background: rgba(5, 21, 37, 0.95); border-left: 4px solid var(--accent-cyan); color: white;
    padding: 15px 25px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    display: flex; align-items: center; gap: 15px; min-width: 300px;
    font-family: 'Inter', sans-serif; animation: slideIn 0.3s ease-out forwards; backdrop-filter: blur(5px);
    border: 1px solid rgba(255,255,255,0.1); font-weight: 600; letter-spacing: 0.5px;
}
.toast.error { border-left-color: var(--accent-red); }
.toast.success { border-left-color: var(--accent-green); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideOut { to { transform: translateX(100%); opacity: 0; } }

/* LAYOUT */
.sidebar {
    position: fixed; left: 0; top: 0; width: 280px; height: 100%;
    background: linear-gradient(180deg, rgba(2, 10, 19, 1) 0%, rgba(0, 30, 60, 1) 100%);
    border-right: 1px solid rgba(0, 247, 255, 0.1); color: var(--text-bright);
    display: flex; flex-direction: column; padding: 40px 30px; z-index: 10; box-shadow: 10px 0 30px rgba(0,0,0,0.5);
}
.sidebar h2 { font-size: 24px; color: var(--accent-cyan); text-shadow: var(--glow-cyan); margin-bottom: 20px; font-weight: 800; }
.sidebar p { color: var(--text-dim); line-height: 1.6; font-size: 14px; margin-bottom: auto; }
.stats-box { background: rgba(0, 247, 255, 0.05); border: 1px solid rgba(0, 247, 255, 0.2); padding: 20px; border-radius: 12px; margin-top: 30px; }
.status-led { width: 8px; height: 8px; background: var(--accent-cyan); border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 10px var(--accent-cyan); animation: blink 2s infinite; }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

.main-content { margin-left: 280px; width: calc(100% - 280px); height: 100%; padding: 40px; overflow-y: auto; }
.header-row { display: flex; align-items: center; gap: 20px; margin-bottom: 40px; }
h1 { color: var(--text-bright); font-size: 32px; font-weight: 800; letter-spacing: 1px; }
.backButton { background: transparent; border: 1px solid var(--accent-cyan); color: var(--accent-cyan); padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: 700; transition: 0.3s; }
.backButton:hover { background: var(--accent-cyan); color: #000; box-shadow: var(--glow-cyan); }

.user-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; padding-bottom: 50px; }
.user-card { background: rgba(5, 21, 37, 0.6); backdrop-filter: blur(5px); border: var(--border-glow); border-radius: 16px; padding: 20px; display: flex; align-items: center; justify-content: space-between; transition: all 0.3s; }
.user-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 247, 255, 0.15); border-color: var(--accent-cyan); }
.user-info { display: flex; align-items: center; gap: 20px; }
.user-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--text-dim); transition: 0.3s; }
.user-avatar:hover { border-color: var(--accent-cyan); box-shadow: var(--glow-cyan); cursor: pointer; }
.user-details { display: flex; flex-direction: column; }
.user-name { font-size: 18px; font-weight: 700; color: var(--text-bright); margin-bottom: 4px; }
.user-id { font-size: 12px; color: var(--text-dim); letter-spacing: 1px; }

.action-buttons { display: flex; gap: 10px; }
.btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 12px; transition: 0.3s; }
.btn-edit { background: rgba(0, 247, 255, 0.1); color: var(--accent-cyan); border: 1px solid rgba(0, 247, 255, 0.3); }
.btn-edit:hover { background: var(--accent-cyan); color: #000; box-shadow: var(--glow-cyan); }
.btn-delete { background: rgba(255, 42, 109, 0.1); color: var(--accent-red); border: 1px solid rgba(255, 42, 109, 0.3); }
.btn-delete:hover { background: var(--accent-red); color: #fff; box-shadow: 0 0 15px var(--accent-red); }

.screen { display: none; animation: fadeUp 0.5s ease-out; }
.screen.active { display: block; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.edit-container { background: var(--glass-panel); border: var(--border-glow); padding: 50px; border-radius: 20px; max-width: 500px; margin: 0 auto; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
.edit-preview-img { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--accent-cyan); box-shadow: var(--glow-cyan); margin-bottom: 30px; }
.form-group { text-align: left; margin-bottom: 25px; }
.form-group label { display: block; color: var(--accent-cyan); font-size: 12px; font-weight: 700; margin-bottom: 10px; }
input[type="text"] { width: 100%; padding: 15px; background: rgba(0, 247, 255, 0.05); border: 1px solid rgba(0, 247, 255, 0.2); color: white; border-radius: 10px; outline: none; transition: 0.3s; }
input[type="text"]:focus { border-color: var(--accent-cyan); background: rgba(0, 247, 255, 0.1); }
.btn-save { background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan)); color: #000; padding: 12px 30px; font-size: 14px; }
.btn-cancel { background: transparent; border: 1px solid var(--text-dim); color: var(--text-dim); padding: 12px 30px; }
.image-modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(2, 10, 19, 0.95); justify-content: center; align-items: center; flex-direction: column; }
.image-modal.active { display: flex; }
.modal-content { max-width: 80%; max-height: 80vh; border: 2px solid var(--accent-cyan); box-shadow: 0 0 50px rgba(0, 247, 255, 0.2); border-radius: 12px; }
.close-modal { position: absolute; top: 40px; right: 40px; color: var(--text-bright); font-size: 40px; cursor: pointer; }
</style>
</head>
<body>

<div id="toast-container"></div>

<div class="sidebar">
    <h2 id="sidebar-title">DATA CENTER</h2>
    <p id="sidebar-desc">Manage enrolled identities. All changes are synchronized with the parallel processing engine.</p>
    <div class="stats-box">
        <div style="font-size:11px; color:var(--text-dim); margin-bottom:8px;">CONNECTION STATUS</div>
        <strong style="color: var(--accent-cyan); display:flex; align-items:center;"><span class="status-led"></span> SYSTEM ONLINE</strong>
    </div>
</div>

<div class="main-content">
   <div id="data-screen" class="screen active">
        <div class="header-row">
            <button class="backButton" onclick="window.location.href='index.html?active=dataset'">← RETURN</button>
            <h1>ENROLLED SUBJECTS</h1>
        </div>
        <div class="user-grid" id="user-list-container"></div>
    </div>

    <div id="edit-screen" class="screen">
        <div class="edit-container">
            <h2>MODIFY RECORD</h2>
            <img id="edit-preview" src="" class="edit-preview-img">
            <div class="form-group">
                <label>UPDATE PHOTO</label>
                <input type="file" id="edit-file-input" accept="image/*" style="display:block; color:var(--text-dim);">
            </div>
            <div class="form-group">
                <label>SUBJECT DESIGNATION</label>
                <input type="hidden" id="edit-old-filename">
                <input type="text" id="edit-name-input" placeholder="Enter Name">
            </div>
            <div style="margin-top:30px; display:flex; justify-content:center; gap:15px;">
                <button class="btn btn-cancel" onclick="showDataScreen()">CANCEL</button>
                <button class="btn btn-save" onclick="saveChanges()">SAVE CHANGES</button>
            </div>
        </div>
    </div>
</div>

<div id="image-viewer" class="image-modal" onclick="closeImageViewer(event)">
    <span class="close-modal" onclick="closeImageViewer(event)">&times;</span>
    <img class="modal-content" id="full-image">
    <div style="color:var(--accent-cyan); margin-top:20px; font-size:20px; font-weight:700;" id="image-caption"></div>
</div>

<script>
const userListContainer = document.getElementById('user-list-container');
const dataScreen = document.getElementById('data-screen'); editScreen = document.getElementById('edit-screen'); editNameInput = document.getElementById('edit-name-input'); editPreview = document.getElementById('edit-preview'); editFileInput = document.getElementById('edit-file-input'); oldFilenameInput = document.getElementById('edit-old-filename'); imageModal = document.getElementById('image-viewer'); fullImage = document.getElementById('full-image'); imageCaption = document.getElementById('image-caption');
let currentEditingId = null; let users = [];

// --- HOLOGRAPHIC TOAST FUNCTION ---
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    let icon = 'ℹ️';
    if(type === 'success') icon = '✅';
    if(type === 'error') icon = '⚠️';
    toast.innerHTML = `<span style="font-size:18px">${icon}</span> <span>${message}</span>`;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.5s ease-in forwards';
        setTimeout(() => toast.remove(), 500);
    }, 3000);
}

async function init() {
    try { const res = await fetch('/users'); users = await res.json(); renderList(); } catch(e) { console.error("Error:", e); }
}

function renderList() {
    userListContainer.innerHTML = '';
    if(users.length === 0) { userListContainer.innerHTML = '<p style="color:var(--text-dim);">No records found in database.</p>'; return; }
    users.forEach(user => {
        const card = document.createElement('div'); card.className = 'user-card';
        card.innerHTML = `<div class="user-info"><img src="${user.img}" class="user-avatar" onclick="openImageViewer('${user.img}', '${user.name}')"><div class="user-details"><span class="user-name">${user.name}</span><span class="user-id">ID: #${user.id.toString().padStart(4, '0')}</span></div></div><div class="action-buttons"><button class="btn btn-edit" onclick="openEditScreen(${user.id})">EDIT</button><button class="btn btn-delete" onclick="deleteUser(${user.id})">DEL</button></div>`;
        userListContainer.appendChild(card);
    });
}

function showDataScreen() { dataScreen.classList.add('active'); editScreen.classList.remove('active'); currentEditingId = null; }
function openEditScreen(id) {
    const user = users.find(u => u.id === id); if (!user) return;
    currentEditingId = id; editNameInput.value = user.name; editPreview.src = user.img; editFileInput.value = ""; oldFilenameInput.value = user.img.split('/').pop();
    dataScreen.classList.remove('active'); editScreen.classList.add('active');
}

editFileInput.addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) { const reader = new FileReader(); reader.onload = (e) => editPreview.src = e.target.result; reader.readAsDataURL(file); }
});

async function saveChanges() {
    const newName = editNameInput.value.trim();
    if (!newName) return showToast("Name cannot be empty.", "error");
    const oldFilename = oldFilenameInput.value;
    const formData = new FormData();
    formData.append("oldFilename", oldFilename); formData.append("newName", newName);
    if (editFileInput.files.length > 0) formData.append("image", editFileInput.files[0]);
    try {
        const res = await fetch("/edit", { method: "PUT", body: formData });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        showToast("Record Updated Successfully.", "success"); await init(); showDataScreen();
    } catch (err) { showToast("Update Failed.", "error"); }
}

async function deleteUser(id) {
    const user = users.find(u => u.id === id);
    if(!confirm(`WARNING: Permanently delete record for ${user.name}?`)) return;
    const filename = user.img.split('/').pop();
    try {
        await fetch('/delete', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filename }) });
        await init(); showToast("Record Deleted.", "success");
    } catch(err) { showToast("Delete failed.", "error"); }
}

function openImageViewer(src, name) { fullImage.src = src; imageCaption.innerText = name; imageModal.classList.add('active'); }
function closeImageViewer(event) { if (event.target !== fullImage) imageModal.classList.remove('active'); }
init();
</script>
</body>
</html>